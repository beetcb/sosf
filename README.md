### sosf

**S**everless **O**neDrive & **S**harePoint **F**unction.

æˆ–è®¸æ˜¯**å›½å†…**è®¿é—®æœ€å¿«çš„ OneDrive **å…æœåŠ¡å™¨**å›¾åºŠç¨‹åº(æˆ–è§†é¢‘åºŠã€éŸ³ä¹åºŠã€...åºŠ)ï¼Œä¸“ä¸º**ä¸–çºªäº’è”**ç”¨æˆ·æ‰“é€ 

ğŸŒ¡æ³¨æ„ï¼šå—é™äºå›½å†…ç½‘ç»œç¯å¢ƒï¼Œæœ¬è¯´æ˜å›¾ç‰‡å¯èƒ½ä¸èƒ½æ­£å¸¸æ˜¾ç¤ºï¼Œæˆ–è€…ä½ æƒ³æŸ¥çœ‹éƒ¨ç½²çš„æ•ˆæœï¼Œè¯·æŸ¥çœ‹ [æ­¤ç¯‡åšæ–‡](https://www.beetcb.com/posts/22/)

> æ³¨ï¼šSharePoint æ–‡æ¡£å‚¨å­˜åŠŸèƒ½å’Œ OneDrive ç½‘ç›˜ç±»ä¼¼ï¼Œæœ¬è¯´æ˜å°†ä»–ä»¬ç»Ÿç§°ä¸º OneDriveã€‚

### ç‰¹ç‚¹

- ä¸ç°æœ‰å…è´¹å›¾åºŠæœåŠ¡çš„åŒºåˆ«ï¼šæˆ‘ä»¬æœ‰ OneDrive ğŸ˜ï¼Œæ‰€ä»¥ sosf å¯ä»¥æ‰˜ç®¡ä»»ä½•æ–‡ä»¶(å›¾ç‰‡ã€è§†é¢‘ã€ä¸‹è½½é“¾æ¥)ï¼Œå¹¶ä¸”æ— å‚¨å­˜ç©ºé—´é™åˆ¶(å‡ ä¹ï¼Œä½ ç”šè‡³è¿˜å¯ä»¥ç”¨ SharePoint æ‰©å±•ç©ºé—´)

- è®¿é—®é€Ÿåº¦å¿«ï¼š`sosf` ä½¿ç”¨å›½å†… Severless ä¾›åº”å•†æä¾›çš„å…è´¹æœåŠ¡(ä¸€èˆ¬å¸¦æœ‰ CDN)ï¼Œè®¿é—®å›½å†…çš„ä¸–çºªäº’è”ï¼Œé€Ÿåº¦è‡ªç„¶æœ‰è´¨çš„é£è·ƒ

- CLI é…ç½®ï¼Œç®€å•å¿«é€Ÿï¼šå¾®è½¯ Graph çš„æˆæƒè¿‡ç¨‹æ¯”è¾ƒéº»çƒ¦ï¼Œä¸ºæ­¤æˆ‘æä¾›äº†ä¸€ä¸ª cli å·¥å…·æ¥åŠ å¿«éƒ¨ç½²ã€‚ç”¨æˆ·å¡«å…¥æ‰€æœ‰çš„é…ç½®é¡¹åï¼Œè¯¥å·¥å…·è‡ªåŠ¨å†™å…¥é…ç½®æ–‡ä»¶ï¼Œæ— éœ€å¤šä½™æ“ä½œ

- è®¾è®¡ä»ç®€ï¼š`sosf` åªéªŒè¯å¹¶è·å– Onedrive æ–‡ä»¶ç›´é“¾ï¼Œå¹¶é‡å®šå‘è¿‡å»(è¿™ä¹Ÿæ„å‘³ç€å®ƒæ²¡æœ‰å‰ç«¯é¡µé¢ï¼Œå¦‚æœä½ æ°å¥½æœ‰è¿™ç§éœ€æ±‚ï¼Œ[onedrive-cf-index](https://github.com/spencerwooo/onedrive-cf-index) ä¸ºä¸äºŒä¹‹é€‰)

- æ•™ç¨‹å®Œå¤‡ï¼šæœ¬è¯´æ˜å¸¦æœ‰ååˆ†å¨å” çš„éƒ¨ç½²æ•™ç¨‹ï¼Œå„ä¸ªå¹³å°éƒ½å›Šæ‹¬å…¶ä¸­

- å¤šå¹³å°éƒ¨ç½²æ”¯æŒ

  - [Leancloud äº‘å¼•æ“å¼€å‘ç‰ˆ](https://www.leancloud.cn/engine/)ï¼šé™åˆ¶æ˜¯æ¯å¤© 1GB å¤–ç½‘å‡ºæµé‡ï¼Œ`sosf` æµé‡æ¶ˆè€—å°‘ï¼Œæˆ‘ç›¸ä¿¡ 1GB å®Œå…¨å¤Ÿç”¨äº†ã€‚æ­¤å¤–ï¼Œå…¬ç½‘è®¿é—®å¿…é¡»ç»‘å®šå¤‡æ¡ˆåŸŸåï¼Œè¯¦è§ [å®šä»·](https://www.leancloud.cn/pricing/)ã€‚
  - [è…¾è®¯äº‘å¼€å‘å…è´¹é¢åº¦](https://cloud.tencent.com/product/tcb)ï¼šå®ƒçš„é™åˆ¶å°±å¤šäº†ï¼Œé¦–å…ˆäº‘å‡½æ•°æ¯æœˆæœ‰ä½¿ç”¨é‡é™åˆ¶ `æ‰§è¡Œå†…å­˜(GB) * æ‰§è¡Œæ—¶é—´(s)` ä¸º 1000 GBsï¼Œå¹¶ä¸”äº‘å‡½æ•°å…¬ç½‘è®¿é—®æœˆæµé‡é™åˆ¶ä¸º 1 GBï¼Œè¯¦è§ [å…è´¹é¢åº¦](https://cloud.tencent.com/document/product/876/39095)ã€‚ æ‰€ä»¥æˆ‘æ¨èä½¿ç”¨ leancloudã€‚

  é™¤æ­¤ä¹‹å¤–ï¼Œ[Vercel](https://vercel.com/docs/serverless-functions/introduction) å›½å†…è®¿é—®é€Ÿåº¦ä¹Ÿä¸é”™ï¼Œä¸éœ€è¦å¤‡æ¡ˆï¼Œå…è´¹é¢åº¦ä¹Ÿç»å¯¹å¤Ÿç”¨ï¼šäº‘å‡½æ•°ä½¿ç”¨é‡ 360000 GBsï¼Œæœˆæµé‡ 100 GB, è¯¦è§ [Fair Use Policy](https://vercel.com/docs/platform/fair-use-policy)(è‰¯å¿ƒï¼ğŸŒ¸)

- éµå®ˆ[åˆç†ä½¿ç”¨](https://vercel.com/docs/platform/fair-use-policy)è§„èŒƒï¼šåœ¨æˆ‘ä»¬ä½¿ç”¨è¿™äº›äº‘æœåŠ¡å•†è¡¨ç¤ºæ”¯æŒçš„åŒæ—¶ï¼Œä¹Ÿè¦~~ä¼˜é›…è–…ç¾Šæ¯›~~åˆç†ä½¿ç”¨

### éƒ¨ç½²æŒ‡å—

#### OneDrive é…ç½®å¹¶æˆæƒ

1. Azure æ§åˆ¶å°é¡¶æ æœç´¢`åº”ç”¨æ³¨å†Œ`â‡¢ æ–°æ³¨å†Œ â‡¢ å—æ”¯æŒçš„è´¦æˆ·ç±»å‹å¡«å…¥`ä»»ä½•ç»„ç»‡ç›®å½•(ä»»ä½• Azure AD ç›®å½• - å¤šç§Ÿæˆ·)ä¸­çš„å¸æˆ·`â‡¢ é‡å®šå‘ uri å¡«å…¥ `http://localhost`â‡¢ è·å– `åº”ç”¨ç¨‹åº(å®¢æˆ·ç«¯) ID (client_id)`

2.

- OneDrive ç”¨æˆ·å·¦ç®¡ç†æ  API æƒé™ â‡¢ æ·»åŠ æƒé™ `offine-access`ã€`files.read.all`ã€`files.read.write.all`â‡¢ å·¦ç®¡ç†æ è¯ä¹¦å’Œå¯†ç  â‡¢ åˆ›å»ºå¹¶è·å– `å®¢æˆ·ç«¯å¯†ç  client-secret`
- SharePoint ç”¨æˆ·å·¦ç®¡ç†æ  API æƒé™ â‡¢ æ·»åŠ æƒé™ `offine-access`ã€`sites.read.all`ã€`sites.read.write.all`â‡¢ å·¦ç®¡ç†æ è¯ä¹¦å’Œå¯†ç  â‡¢ åˆ›å»ºå¹¶è·å– `å®¢æˆ·ç«¯å¯†ç  (client-secret)` â‡¢ åˆ›å»ºå¹¶è·å– client-secret å’Œä»¥ä¸‹ä¸¤é¡¹é¢å¤–å‚æ•°:

  - hostName: ä½ çš„ SharePoint Hostï¼Œæ¯”å¦‚ `cos.sharepoint.cn`
  - sitePath: ä½ çš„ SharePoint ç½‘ç«™ç›¸å¯¹ä½ç½®ï¼Œæ¯”å¦‚ `/sites/cos`

  æ¯”å¦‚æˆ‘çš„ SharePoint è®¿é—®ç½‘å€ä¸º `https://odbeet.sharepoint.cn/sites/beet`ï¼Œåˆ™ `hostName` å€¼ä¸º `odbeet.sharepoint.cn`ï¼Œ`sitePath` å€¼ä¸º `/sites/beet`ï¼Œè¿™æ˜¯æœ€å¿«åˆ¤æ–­ä¸Šè¿°ä¸¤è€…å–å€¼çš„æ–¹æ³•

3. å¾—åˆ°ä¸Šè¿°é…ç½®å‚æ•°åï¼Œè¯·ä¿å­˜å¥½ç•™ä½œåç”¨

#### äº‘å¹³å°é…ç½®å¹¶éƒ¨ç½²

> è¯·åœ¨ä»¥ä¸‹ä¸‰ç§å¹³å°ä¸­ä»»é€‰å…¶ä¸€ã€‚æ­¤å¤–ï¼Œ`.env` æ–‡ä»¶åŒ…å«å„ç§æ•æ„Ÿå‚æ•°ï¼Œsosf é»˜è®¤æŠŠå®ƒåˆ—å…¥ .gitignoreã€‚å› æ­¤ï¼Œæ¨èä½¿ç”¨å„å¹³å°æä¾›çš„ cli å‘½ä»¤è¡Œå¯¼å…¥, è€Œä¸è¦ä½¿ç”¨ git repo å¯¼å…¥

ä¸€. Leancloud äº‘å¼•æ“

> leancloud ä¸æ”¯æŒå¯¼å…¥æ¨¡æ¿åº”ç”¨ï¼Œæ‰€ä»¥é…ç½®ç›¸å¯¹éº»çƒ¦

0. é…ç½®æœºå¯†å‹ç¯å¢ƒå˜é‡ï¼š

   ```bash
   git clone https://github.com/beetcb/sosf.git && cd sosf
   npm i
   npm run auth
   # åœ¨æ­¤æ ¹æ®æç¤ºå¼€å§‹é…ç½®
   ```

   é…ç½®å®Œæˆåï¼Œsosf ä¼šåˆ›å»ºä¸€ä¸ª `.env` æ–‡ä»¶ï¼Œå†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š

   ![.env](https://i.imgur.com/iTGXe8I.png)

1. æ³¨å†Œ Leancloud å¼€å‘æ¿å¹¶è¿›å…¥æ§åˆ¶å°
2. åˆ›å»ºå¼€å‘ç‰ˆåº”ç”¨å¹¶è¿›å…¥åº”ç”¨ç®¡ç†ç•Œé¢
3. å·¦å‚¨å­˜æ ç»“æ„åŒ–æ•°æ® â‡¢ åˆ›å»º `class` â‡¢ åç§°å¡«å…¥ `sosf`ï¼Œå…¶å®ƒé»˜è®¤ â‡¢ ç‚¹å‡»è¯¥ class åç§°ï¼Œå³æ æ·»åŠ è¡Œ â‡¢ è·å–æ­¤è¡Œçš„ `ObjectId` å€¼(æ¯”å¦‚ `d1d037116a8d1c4ad56017e9`) â‡¢ åœ¨é¡¹ç›®æ ¹ç›®å½• `.env` æ–‡ä»¶é‡Œæ–°å¢

   ```js
   dbId = 6017e9d1d037116a8d1c4ad5
   ```

   è¿™ä¸€æ­¥æ˜¯ä¸ºäº†æŒä¹…ä¿å­˜è®¿é—® graph çš„ `access-token`ï¼Œå› ä¸º severless function æ˜¯æ— çŠ¶æ€çš„

   æ­¤æ—¶ `.env` çŠ¶æ€å¤§æ¦‚æ˜¯è¿™æ ·ï¼š

   ![.env db](https://i.imgur.com/XoSDuz6.png)

4. å®‰è£… lean cli â‡¢ ç™»å½• â‡¢ éƒ¨ç½²ä½ çš„ sosf é¡¹ç›®

- [å®‰è£…æ–‡æ¡£](https://leancloud.cn/docs/leanengine_cli.html#hash1443149115)
- [éƒ¨ç½²æ–‡æ¡£](https://leancloud.cn/docs/leanengine_cli.html#hash-1210017446)

5. éƒ¨ç½²æˆåŠŸåï¼Œæˆ‘ä»¬å›åˆ°æ§åˆ¶å°ï¼Œå·¦è®¾ç½®æ åŸŸåç»‘å®š â‡¢ åœ¨æ­¤ç»‘å®šä½ çš„åŸŸåå¹¶é…ç½® DNS

6. è®¿é—®åœ°å€ç¤ºä¾‹ï¼š`https://domain.com/path/to/file.md`

äºŒ. Vercel äº‘å‡½æ•°

0. é…ç½®æœºå¯†å‹ç¯å¢ƒå˜é‡ï¼š

   ```bash
   git clone -b vercel https://github.com/beetcb/sosf.git && cd sosf
   npm i
   npm run auth
   # åœ¨æ­¤æ ¹æ®æç¤ºå¼€å§‹é…ç½®
   ```

1. æ³¨å†Œ[å›½é™… Leancloud å¼€å‘æ¿](https://console.leancloud.app/)å¹¶è¿›å…¥æ§åˆ¶å°
2. åˆ›å»ºå¼€å‘ç‰ˆåº”ç”¨å¹¶è¿›å…¥åº”ç”¨ç®¡ç†ç•Œé¢
3. å·¦å‚¨å­˜æ ç»“æ„åŒ–æ•°æ® â‡¢ åˆ›å»º `class` â‡¢ åç§°å¡«å…¥ `sosf`ï¼Œå‹¾é€‰`æ— é™åˆ¶`ï¼Œå…¶å®ƒé»˜è®¤ â‡¢ ç‚¹å‡»è¯¥ class åç§°ï¼Œå³æ æ·»åŠ è¡Œ â‡¢ è·å–æ­¤è¡Œçš„ `ObjectId` å€¼(æ¯”å¦‚ `d1d037116a8d1c4ad56017e9`) â‡¢ å·¦è®¾ç½®æ åº”ç”¨ keysï¼Œå¤åˆ¶ Credentials ä¸‹çš„å‰ä¸¤ä¸ªå‚æ•°çš„å€¼(AppID AppKey) â‡¢ åœ¨é¡¹ç›®æ ¹ç›®å½• `.env` æ–‡ä»¶é‡Œæ–°å¢è¿™ä¸‰é¡¹ key-valueï¼Œä¾‹å¦‚ï¼š

   ```js
   dbId = d1d037116a8d1c4ad56017e9
   AppID = rrdYFdniaMdYXbMMIUGUusc64SMJTevMY
   AppKey = IkoR0JGItmcYnyAsqoySF7Fc
   ```

   åŒæ ·ï¼ŒdbId æ˜¯ä¸ºäº†æŒä¹…ä¿å­˜è®¿é—® graph çš„ `access-token`ï¼Œå› ä¸º severless function æ˜¯æ— çŠ¶æ€çš„ã€‚è€Œä¸”ç”±äºæˆ‘ä»¬åœ¨ vercel é‡Œé¢è®¿é—® leancloud çš„æ•°æ®åº“ï¼Œéœ€è¦é¢å¤–çš„éªŒè¯å€¼(AppID AppKey)

4. å®‰è£… vercel cli å¹¶ç™»å½•ï¼š

   ```bash
   npm i -g vercel
   vercel login
   ```

5. éƒ¨ç½²ï¼š

   ```bash
   vercel --prod
   # æŒ‰ç…§æç¤ºå®Œæˆéƒ¨ç½²
   ```

   åˆ°æ­¤éƒ¨ç½²å®Œæˆï¼Œè®¿é—®åœ°å€å¯ä»¥åœ¨å‘½ä»¤è¡Œæˆ– vercel å®˜ç½‘çœ‹åˆ°ã€‚éœ€è¦ä½¿ç”¨è‡ªå®šä¹‰åŸŸåï¼Œè¯·å‚è€ƒ [custom-domains](https://vercel.com/docs/custom-domains#)
6. è®¿é—®åœ°å€ç¤ºä¾‹ï¼š`https://domain.com/?path=/path/to/file.md`

ä¸‰. è…¾è®¯äº‘å¼€å‘ tcb

0. é…ç½®æœºå¯†ç¯å¢ƒå˜é‡ï¼š

   ```bash
   git clone -b tcb-scf https://github.com/beetcb/sosf.git && cd sosf
   npm i
   npm run auth
   # åœ¨æ­¤æ ¹æ®æç¤ºå¼€å§‹é…ç½®
   ```

1. è¿›å…¥äº‘å¼€å‘[æ§åˆ¶å°](https://console.cloud.tencent.com/tcb) â‡¢ ç©ºæ¨¡æ¿ â‡¢ ç¡®ä¿é€‰æ‹©è®¡è´¹æ–¹å¼`åŒ…å¹´åŒ…æœˆ`, å¥—é¤ç‰ˆæœ¬`å…è´¹ç‰ˆ`(è¿™æ ·èƒ½å¤Ÿç¡®ä¿å…è´¹é¢åº¦è¶…å‡ºåä¸ç»§ç»­æ‰£è´¹) â‡¢ è¿›å…¥æ§åˆ¶å°
2. ç¯å¢ƒæ€»è§ˆä¸‹å¤åˆ¶ `ç¯å¢ƒ ID(envId)` â‡¢ å¹¶æ”¹åŠ¨æœ¬åœ°ä»£ç ä¸­ `cloudbaserc.json` ä¸­çš„ `envId`
3. å®‰è£… tcb cli å¹¶æˆæƒç™»å½•ï¼š

   ```bash
   npm i -g @cloudbase/cli
   tcb login
   ```

4. éƒ¨ç½²äº‘å‡½æ•°ï¼š

   ```bash
   tcb fn deploy
   ```

5. æŒ‡å®š HTTP è®¿é—®è·¯å¾„ï¼š

   ```bash
   tcb service create -p / -f sosf
   # è®©å‡½æ•°åœ¨æ ¹ç›®å½•è§¦å‘
   ```

6. ç­‰å¾…å‡ åˆ†é’Ÿï¼Œå°±å¯ä»¥å¼€å§‹é¢„è§ˆäº†ï¼Œè®¿é—®ç¤ºä¾‹ï¼š`https://domain.com/path/to/file.md`

### ä½œè€…

[`beetcb`](https://www.beetcb.com)

é‚®ç®±: `i@beetcb.com`

### é¸£è°¢

- [Tencent tcb](https://github.com/TencentCloudBase)
- [Leancloud](https://github.com/leancloud)
- [Vercel](https://github.com/vercel/vercel)
